@Library('my-shared-library') _
pipeline {
    agent { label 'worker1' }
    environment {
        IMAGE_NAME = 'saeedgebaly/app'
        DOCKER_REGISTRY_FILE = "deployment.yaml"
    }
    stages {
        stage('Run Unit Tests') {
            steps {
                UnitTests()
            }
        }
        stage('Build the Application') {
            steps {
                buildApp()
            }
        }
        stage('Build Docker Image') {
            steps {
                buildDockerImage()
            }
        }
        stage('Delete Docker Image') {
            steps {
                removeDockerImage()
            }
        }
        stage('Update Deployment deployment.yaml') {
            steps {
                deployToK8s()
            }
        }
        stage('Deploy to Kubernetes') {
            steps {
                deployToK8s()
            }
        }
    }
        post {
            always {
                echo 'pipeline completed'
            }
            success {
                echo 'pipeline completed successfully'
            }
            failure {
                echo 'pipeline completed with failure'
            }
        }
    }