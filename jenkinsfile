pipeline {
    agent { label 'worker1' }
    environment {
        IMAGE_NAME = 'saeedgebaly/app'
        DOCKER_REGISTRY_FILE = "deployment.yaml"
    }
    stages {
        stage('Run Unit Tests') {
            steps {
                load 'vars/unitTests.groovy'
                unitTests()
            }
        }
        stage('Build the Application') {
            steps {
                load 'vars/buildApp.groovy'
                buildApp()
            }
        }
        stage('Build Docker Image') {
            steps {
                load 'vars/buildDockerImage.groovy'
                buildDockerImage()
            }
        }
        stage('Delete Docker Image') {
            steps {
                load 'vars/removeDockerImage.groovy'
                removeDockerImage()
            }
        }
        stage('Update Deployment deployment.yaml') {
            steps {
                load 'vars/deployToK8s.groovy'
                deployToK8s()
            }
        }
        stage('Deploy to Kubernetes') {
            steps {
                load 'vars/deployToK8s.groovy'
                deployToK8s()
            }
        }
    }
        post {
            always {
                echo 'pipeline completed'
            }
            success {
                echo 'pipeline completed successfully'
            }
            failure {
                echo 'pipeline completed with failure'
            }
        }
    }